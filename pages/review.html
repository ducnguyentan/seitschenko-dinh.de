<!DOCTYPE html>
<!--
  Dentist Review Form - Bewertungsformular f√ºr Zahn√§rzte
  ========================================================
  Patient review form to evaluate dentist treatment experience.
-->
<html lang="de" id="html-root">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title id="page-title">Behandlung bewerten - Seitschenko-Dinh</title>
  <meta name="description" content="Bewerten Sie Ihre Behandlung bei Seitschenko-Dinh" id="page-description">
  <link href="../css/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* Star rating styles */
    .star-rating {
      display: flex;
      gap: 8px;
      font-size: 3rem;
      cursor: pointer;
      justify-content: center;
      margin: 20px 0;
    }

    .star {
      color: #d1d5db;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .star:hover,
    .star.active {
      color: #fbbf24;
      transform: scale(1.2);
      filter: drop-shadow(0 4px 8px rgba(251, 191, 36, 0.4));
    }

    .star.active {
      animation: star-pulse 0.5s ease;
    }

    @keyframes star-pulse {
      0%, 100% { transform: scale(1.2); }
      50% { transform: scale(1.4); }
    }

    .review-card {
      background: linear-gradient(135deg, #f0fdfa 0%, #ffffff 100%);
      border: 2px solid #14b8a6;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 8px 24px rgba(20, 184, 166, 0.15);
    }

    .submit-btn {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      transition: all 0.3s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(20, 184, 166, 0.35);
    }

    .submit-btn:disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      cursor: not-allowed;
      transform: none;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-teal-50 via-white to-blue-50 min-h-screen font-poppins">

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <img src="../images/logo.png" alt="Seitschenko-Dinh Logo" class="h-12 w-auto" onerror="this.style.display='none'">
        <h1 class="text-2xl font-bold text-teal-600">Seitschenko-Dinh</h1>
      </div>
      <div class="flex items-center space-x-4">
        <select id="language-selector" class="px-4 py-2 border border-teal-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
          <option value="de" selected>üá©üá™ Deutsch</option>
          <option value="en">üá¨üáß English</option>
          <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8 max-w-3xl">

    <!-- Review Form Card -->
    <div class="review-card">

      <!-- Title -->
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-teal-700 mb-2" data-translate="review.title">
          Bewerten Sie Ihre Behandlung
        </h2>
        <p class="text-gray-600" data-translate="review.subtitle">
          Ihr Feedback hilft uns, unseren Service zu verbessern
        </p>
      </div>

      <!-- Patient Info Display -->
      <div class="bg-white rounded-lg p-6 mb-6 border border-teal-200">
        <h3 class="text-lg font-semibold text-teal-700 mb-3" data-translate="review.treatment_info">
          Behandlungsinformationen
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="font-semibold text-gray-700" data-translate="review.patient_name">Patient:</span>
            <span id="display-patient-name" class="text-gray-600 ml-2">-</span>
          </div>
          <div>
            <span class="font-semibold text-gray-700" data-translate="review.doctor_name">Arzt:</span>
            <span id="display-doctor-name" class="text-gray-600 ml-2">-</span>
          </div>
          <div>
            <span class="font-semibold text-gray-700" data-translate="review.treatment_date">Behandlungsdatum:</span>
            <span id="display-treatment-date" class="text-gray-600 ml-2">-</span>
          </div>
          <div>
            <span class="font-semibold text-gray-700" data-translate="review.patient_id">Patient-ID:</span>
            <span id="display-patient-id" class="text-gray-600 ml-2">-</span>
          </div>
        </div>
      </div>

      <!-- Review Form -->
      <form id="review-form">

        <!-- Star Rating -->
        <div class="mb-8">
          <label class="block text-lg font-semibold text-gray-700 mb-3 text-center" data-translate="review.rating_label">
            Wie bewerten Sie Ihre Behandlung?
          </label>
          <div class="star-rating" id="star-rating">
            <span class="star" data-rating="1">&#9733;</span>
            <span class="star" data-rating="2">&#9733;</span>
            <span class="star" data-rating="3">&#9733;</span>
            <span class="star" data-rating="4">&#9733;</span>
            <span class="star" data-rating="5">&#9733;</span>
          </div>
          <p class="text-center text-sm text-gray-500 mt-2" data-translate="review.rating_hint">
            Klicken Sie auf die Sterne (1 = sehr schlecht, 5 = ausgezeichnet)
          </p>
          <input type="hidden" id="rating-value" name="rating" required>
        </div>

        <!-- Review Text -->
        <div class="mb-8">
          <label for="review-text" class="block text-lg font-semibold text-gray-700 mb-3" data-translate="review.comment_label">
            Ihre Bewertung (optional)
          </label>
          <textarea
            id="review-text"
            name="reviewText"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
            placeholder="Teilen Sie Ihre Erfahrungen mit uns..."
            data-translate-placeholder="review.comment_placeholder"
          ></textarea>
          <p class="text-sm text-gray-500 mt-2" data-translate="review.comment_hint">
            Beschreiben Sie Ihre Erfahrung mit dem Arzt und der Behandlung
          </p>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button
            type="submit"
            id="submit-btn"
            class="submit-btn px-8 py-4 text-white text-lg font-semibold rounded-lg disabled:opacity-50"
            disabled
          >
            <span data-translate="review.submit_btn">Bewertung absenden</span>
          </button>
        </div>
      </form>

      <!-- Success Message (hidden initially) -->
      <div id="success-message" class="hidden mt-8 p-6 bg-green-50 border-2 border-green-500 rounded-lg text-center">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h3 class="text-2xl font-bold text-green-700 mb-2" data-translate="review.success_title">
          Vielen Dank f√ºr Ihre Bewertung!
        </h3>
        <p class="text-green-600" data-translate="review.success_message">
          Ihr Feedback wurde erfolgreich √ºbermittelt.
        </p>
      </div>

      <!-- Error Message (hidden initially) -->
      <div id="error-message" class="hidden mt-8 p-6 bg-red-50 border-2 border-red-500 rounded-lg text-center">
        <div class="text-6xl mb-4">‚ùå</div>
        <h3 class="text-2xl font-bold text-red-700 mb-2" data-translate="review.error_title">
          Fehler beim Absenden
        </h3>
        <p class="text-red-600" id="error-text" data-translate="review.error_message">
          Bitte versuchen Sie es sp√§ter erneut.
        </p>
      </div>

    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-gray-100 mt-12 py-8">
    <div class="container mx-auto px-4 text-center text-gray-600">
      <p>&copy; 2025 Seitschenko-Dinh Zahnarztpraxis. Alle Rechte vorbehalten.</p>
    </div>
  </footer>

  <!-- Load translations -->
  <script src="../js/service-translations.js"></script>

  <!-- Review Form Script -->
  <script>
    // Configuration
    const GOOGLE_SHEET_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patientId') || '';
    const patientName = urlParams.get('patientName') || '';
    const doctorName = urlParams.get('doctorName') || '';
    const treatmentDate = urlParams.get('treatmentDate') || '';

    // Display patient info
    document.getElementById('display-patient-id').textContent = patientId || '-';
    document.getElementById('display-patient-name').textContent = patientName || '-';
    document.getElementById('display-doctor-name').textContent = doctorName || '-';
    document.getElementById('display-treatment-date').textContent = treatmentDate || '-';

    // Language handling
    let currentLanguage = 'de';

    function applyTranslations() {
      const elements = document.querySelectorAll('[data-translate]');
      elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        const translation = getNestedTranslation(SERVICE_TRANSLATIONS[currentLanguage], key);
        if (translation) {
          element.textContent = translation;
        }
      });

      // Translate placeholders
      const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
      placeholderElements.forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        const translation = getNestedTranslation(SERVICE_TRANSLATIONS[currentLanguage], key);
        if (translation) {
          element.placeholder = translation;
        }
      });
    }

    function getNestedTranslation(obj, path) {
      return path.split('.').reduce((current, key) => current?.[key], obj);
    }

    // Language selector
    document.getElementById('language-selector').addEventListener('change', function(e) {
      currentLanguage = e.target.value;
      document.documentElement.lang = currentLanguage;
      applyTranslations();
    });

    // Star rating functionality
    let selectedRating = 0;
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('rating-value');
    const submitBtn = document.getElementById('submit-btn');

    stars.forEach(star => {
      star.addEventListener('click', function() {
        selectedRating = parseInt(this.getAttribute('data-rating'));
        ratingInput.value = selectedRating;
        updateStars();
        validateForm();
      });

      star.addEventListener('mouseenter', function() {
        const hoverRating = parseInt(this.getAttribute('data-rating'));
        stars.forEach((s, index) => {
          if (index < hoverRating) {
            s.style.color = '#fbbf24';
          } else {
            s.style.color = selectedRating > index ? '#fbbf24' : '#d1d5db';
          }
        });
      });
    });

    document.querySelector('.star-rating').addEventListener('mouseleave', function() {
      updateStars();
    });

    function updateStars() {
      stars.forEach((star, index) => {
        if (index < selectedRating) {
          star.classList.add('active');
          star.style.color = '#fbbf24';
        } else {
          star.classList.remove('active');
          star.style.color = '#d1d5db';
        }
      });
    }

    function validateForm() {
      // Enable submit button only if rating is selected
      submitBtn.disabled = selectedRating === 0;
    }

    // Form submission
    document.getElementById('review-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      if (selectedRating === 0) {
        alert('Bitte w√§hlen Sie eine Bewertung aus.');
        return;
      }

      const reviewText = document.getElementById('review-text').value.trim();

      const reviewData = {
        action: 'submitReview',
        patientId: patientId,
        patientName: patientName,
        doctorName: doctorName,
        treatmentDate: treatmentDate,
        rating: selectedRating,
        reviewText: reviewText || '-'
      };

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span data-translate="review.submitting">Wird gesendet...</span>';

      try {
        const response = await fetch(GOOGLE_SHEET_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(reviewData)
        });

        // Show success message
        document.getElementById('review-form').style.display = 'none';
        document.getElementById('success-message').classList.remove('hidden');

        // Log success
        console.log('Review submitted successfully');

      } catch (error) {
        console.error('Error submitting review:', error);

        // Show error message
        document.getElementById('error-text').textContent =
          'Fehler: ' + error.message + '. Bitte versuchen Sie es sp√§ter erneut.';
        document.getElementById('error-message').classList.remove('hidden');

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span data-translate="review.submit_btn">Bewertung absenden</span>';
      }
    });

    // Initialize translations
    applyTranslations();
  </script>

</body>
</html>
